{% extends "base.html" %}
{% block title %}Edit Member | open4u{% endblock %}

{% block content %}
<section class="edit-member">
  <h2>ë©¤ë²„ ì •ë³´ ìˆ˜ì •</h2>

  {% if member %}
  <form method="POST" action="{{ url_for('update_member') }}" enctype="multipart/form-data">
    <!-- ëˆ„êµ¬ë¥¼ ìˆ˜ì •í•˜ëŠ”ì§€ ì‹ë³„ -->
    <input type="hidden" name="github_username" value="{{ member.github_username }}"/>

    <label>ì´ë¦„
      <input type="text" name="name" value="{{ member.name }}">
    </label>

    <label>ì˜ì–´ ì´ë¦„
      <input type="text" name="english_name" value="{{ member.english_name }}">
    </label>

    <label>í•œì¤„ ì†Œê°œ
      <input type="text" name="intro" value="{{ member.intro }}">
    </label>

    <!-- âœ… ì—­í• : ì—¬ëŸ¬ ê°œ ì…ë ¥ -->
    <div class="field-group">
      <label>ì—­í• </label>
      {# ì—­í•  ê°’ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ì •ê·œí™” (ë¬¸ìì—´ë¡œ ì €ì¥ëœ ì¼€ì´ìŠ¤ ëŒ€ë¹„) #}
      {% set roles = member.role if member.role is iterable and member.role is not string else [member.role] %}
      {% set roles = roles | select('string') | list %}

      <div class="checkbox-group">
        <label class="checkbox">
          <input type="checkbox" name="role[]" value="Team Leader"
                {% if 'Team Leader' in roles %}checked{% endif %}>
          <span>Team Leader</span>
        </label>
        <label class="checkbox">
          <input type="checkbox" name="role[]" value="Frontend"
                {% if 'Frontend' in roles %}checked{% endif %}>
          <span>Frontend</span>
        </label>

        <label class="checkbox">
          <input type="checkbox" name="role[]" value="Backend"
                {% if 'Backend' in roles %}checked{% endif %}>
          <span>Backend</span>
        </label>
      </div>
    </div>

    <!-- âœ… ì „ê³µ: ì—¬ëŸ¬ ê°œ ì…ë ¥ -->
    <div class="field-group">
      <label>ì „ê³µ</label>
      <div id="majorList">
        {% set majors = member.major if member.major is iterable and member.major is not string else [member.major] %}
        {% for m in majors if m %}
          <div class="row">
            <input type="text" name="major[]" value="{{ m }}">
            <button type="button" class="btn-mini" onclick="this.parentNode.remove()">ì‚­ì œ</button>
          </div>
        {% endfor %}
        {% if majors|length == 0 %}
          <div class="row">
            <input type="text" name="major[]" placeholder="ì˜ˆ: MIS, SW Convergence">
            <button type="button" class="btn-mini" onclick="this.parentNode.remove()">ì‚­ì œ</button>
          </div>
        {% endif %}
      </div>
      <button type="button" class="btn-mini" onclick="addRow('majorList','major[]')">+ ì¶”ê°€</button>
    </div>

    <label>ì „í™”ë²ˆí˜¸
      <input type="text" name="phone" value="{{ member.phone }}">
    </label>

    <label>ì´ë©”ì¼
      <input type="email" name="email" value="{{ member.email }}">
    </label>

    <label>GitHub Username
      <input type="text" name="github_username_view" value="{{ member.github_username }}" disabled>
    </label>

    <!-- âœ… í¬íŠ¸í´ë¦¬ì˜¤ ë§í¬/íŒŒì¼ -->
    <div class="field-group">
      <label>í¬íŠ¸í´ë¦¬ì˜¤ ë§í¬
        <input type="url" name="portfolio_link" value="{{ member.portfolio_link or '' }}" placeholder="https://...">
      </label>
    </div>

    <!-- ğŸ”½ í¬íŠ¸í´ë¦¬ì˜¤ íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ -->
    <div class="field-group">
      <label>í¬íŠ¸í´ë¦¬ì˜¤ íŒŒì¼ (PDF, PPTX ë“±)</label>

      {# âœ… í˜„ì¬ ì €ì¥ëœ íŒŒì¼ ë³´ì—¬ì£¼ê¸° (ë¯¸ë¦¬ë³´ê¸°/ë‹¤ìš´ë¡œë“œ ë§í¬) #}
      {% if member.portfolio_file %}
        <div class="current-file">
          í˜„ì¬ íŒŒì¼:
          <a href="{{ url_for('static', filename='files/' ~ member.portfolio_file) }}"
            target="_blank" download>
            {{ member.portfolio_file }}
          </a>
          <input type="hidden" name="portfolio_file_old" value="{{ member.portfolio_file }}">
          <label class="checkbox-inline">
            <input type="checkbox" name="remove_portfolio_file" value="1">
            ì´ íŒŒì¼ ì‚­ì œ
          </label>
        </div>
      {% else %}
        <p class="muted">í˜„ì¬ ì €ì¥ëœ íŒŒì¼ ì—†ìŒ</p>
      {% endif %}

      <!-- ìƒˆ íŒŒì¼ ì—…ë¡œë“œ -->
      <input type="file" name="portfolio_upload"
            accept=".pdf,.ppt,.pptx,.doc,.docx,.zip">
      <p class="hint">â€» ìƒˆ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ê¸°ì¡´ íŒŒì¼ì„ êµì²´í•©ë‹ˆë‹¤.</p>
    </div>


    <!-- âœ… í¬íŠ¸í´ë¦¬ì˜¤ í”„ë¡œì íŠ¸ ë¦¬ìŠ¤íŠ¸ -->
    <div class="field-group">
      <label>í¬íŠ¸í´ë¦¬ì˜¤ í”„ë¡œì íŠ¸</label>

      <div id="portfolioList">

        {# ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë¯¸ë¦¬ ì±„ì›Œ í‘œì‹œ #}
        {% if member.portfolio %}
          {% for p in member.portfolio %}
            {# ê³µë°± ì œê±° + í•˜ì´í”ˆ -> en-dash ì •ê·œí™” #}
            {% set _clean = (p.period or '').replace(' ', '').replace('-', 'â€“') %}

            {# êµ¬ë¶„ì ìœ„ì¹˜ ì°¾ê¸° #}
            {% set _sep_index = _clean.find('â€“') %}

            {# êµ¬ë¶„ìê°€ ìˆìœ¼ë©´ ì•/ë’¤ë¡œ ë‚˜ëˆ„ê³ , ì—†ìœ¼ë©´ ì „ë¶€ start ë¡œ ì²˜ë¦¬ #}
            {% if _sep_index != -1 %}
              {% set _start = _clean[:_sep_index] %}
              {% set _end   = _clean[_sep_index+1:] %}
            {% else %}
              {% set _start = _clean %}
              {% set _end   = '' %}
            {% endif %}

            {# YYYY.MM -> YYYY-MM ë¡œ ë°”ê¿”ì„œ month inputì— ë§ì¶¤ #}
            {% set _start_month = (_start|replace('.', '-')) if _start else '' %}
            {% set _end_month   = (_end|replace('.', '-')) if _end else '' %}


            <div class="portfolio-row">
              <div class="field-line">
                <input type="text" name="project_title[]" value="{{ p.project_title }}" placeholder="í”„ë¡œì íŠ¸ëª…">
              </div>

              <div class="period-line">
                <input type="month" name="start_month[]" value="{{ _start_month[:7] }}">
                <span class="dash">â€“</span>
                <input type="month" name="end_month[]" value="{{ _end_month[:7] }}">
              </div>

              <div class="field-line">
                <input type="text" name="proj_role[]" value="{{ p.role }}" placeholder="ì—­í• ">
              </div>

              <div class="field-line">
                <input type="text" name="description[]" value="{{ p.description }}" placeholder="ì„¤ëª…">
              </div>

              <input type="hidden" name="period[]" value="{{ p.period }}">

              <div class="row-actions">
                <button type="button" class="btn-mini danger" onclick="this.closest('.portfolio-row').remove()">ì‚­ì œ</button>
              </div>
            </div>

          {% endfor %}
        {% else %}
          <!-- ì´ˆê¸° 1í–‰ -->
          <div class="portfolio-row">
            <div class="field-line">
              <input type="text" name="project_title[]" placeholder="í”„ë¡œì íŠ¸ëª…">
            </div>
            <div class="period-line">
              <input type="month" name="start_month[]">
              <span class="dash">â€“</span>
              <input type="month" name="end_month[]">
            </div>
            <div class="field-line">
              <input type="text" name="proj_role[]" placeholder="ì—­í• ">
            </div>
            <div class="field-line">
              <input type="text" name="description[]" placeholder="ì„¤ëª…">
            </div>
            <input type="hidden" name="period[]" value="">
            <div class="row-actions">
              <button type="button" class="btn-mini danger" onclick="this.closest('.portfolio-row').remove()">ì‚­ì œ</button>
            </div>
          </div>

        {% endif %}
      </div>

      <button type="button" class="btn-mini" onclick="addPortfolioRow()">+ í”„ë¡œì íŠ¸ ì¶”ê°€</button>
    </div>


    <!-- í•˜ë‹¨ ë²„íŠ¼ -->
    <div class="form-actions">
      <button type="submit" class="btn btn-primary">ìˆ˜ì •ì™„ë£Œ</button>
      <button type="button" class="btn" onclick="history.back()">ë’¤ë¡œê°€ê¸°</button>
    </div>
  </form>

  <script>
    function addRow(containerId, fieldName) {
      const box = document.getElementById(containerId);
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `
        <input type="text" name="${fieldName}" />
        <button type="button" class="btn-mini" onclick="this.parentNode.remove()">ì‚­ì œ</button>
      `;
      box.appendChild(row);
    }

    // YYYY-MM -> YYYY.MM
  function ymToDot(ym) {
    if (!ym) return '';
    const [y, m] = ym.split('-');
    if (!y || !m) return '';
    return `${y}.${m.padStart(2,'0')}`;
  }

  function bakePeriodsBeforeSubmit(formEl) {
    const rows = formEl.querySelectorAll('.portfolio-row');
    rows.forEach(row => {
      const start = row.querySelector('input[name="start_month[]"]')?.value || '';
      const end   = row.querySelector('input[name="end_month[]"]')?.value || '';
      const periodHidden = row.querySelector('input[name="period[]"]');

      const s = ymToDot(start);
      const e = ymToDot(end);
      const period = (s && e) ? `${s}â€“${e}` : (s || e); 
      if (periodHidden) periodHidden.value = period;
    });
  }

  function addPortfolioRow() {
    const box = document.getElementById('portfolioList');
    const row = document.createElement('div');
    row.className = 'portfolio-row';
    row.innerHTML = `
      <input type="text" name="project_title[]" placeholder="í”„ë¡œì íŠ¸ëª…" class="w-30">
      <input type="month" name="start_month[]" class="w-18">
      <span class="dash">â€“</span>
      <input type="month" name="end_month[]" class="w-18">
      <input type="text" name="proj_role[]" placeholder="ì—­í• " class="w-18">
      <input type="text" name="description[]" placeholder="ì„¤ëª…" class="w-100">
      <input type="hidden" name="period[]" value="">
      <button type="button" class="btn-mini danger" onclick="this.parentNode.remove()">ì‚­ì œ</button>
    `;
    box.appendChild(row);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('form[action="{{ url_for('update_member') }}"]');
    if (!form) return;
    form.addEventListener('submit', (e) => {
      bakePeriodsBeforeSubmit(form);
    });
  });
  </script>

  {% else %}
    <p>ë©¤ë²„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
  {% endif %}
</section>
{% endblock %}